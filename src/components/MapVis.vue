<script setup>
import {onMounted, reactive, ref} from "vue";
import {DataAdaptor} from "../tools/Adaptor.js";
import "leaflet/dist/leaflet.css";
import * as L from "leaflet";
import "leaflet-switch-basemap/src/L.switchBasemap.js";
import "leaflet-switch-basemap/src/L.switchBasemap.css";
import "leaflet.motion/dist/leaflet.motion.js";
import "leaflet-sidebar-v2/js/leaflet-sidebar.js";
import "leaflet-sidebar-v2/css/leaflet-sidebar.css";
import 'leaflet-arrowheads';

import resizeImageData from "resize-image-data";
import {ElMessage} from 'element-plus'

let map = null;
let myMap = null;
let mapController = null;
let movers = reactive({}); // key为TrackID，value为Mover对象
let motionRugs = null;
let motionRugsDataset = null;
let pixelContainerRef = ref(null);
let eventProcessor = null;
let events = reactive([])

const globalStrategy = "zOrder";
const globalFeature = "Velocity";
const globalDebug = false;

// ========================= 地图自身 =========================


class MyMap {
    constructor() {
        this.zoom = 16;
        this.maxZoom = 20;
        this.minZoom = 10;
        this.nowCenter = [36.111582, -86.713157];
        // this.nowCenter = [38.996791, 117.306754]

        this.tmpMarker = null;

    }

    doSomeTest() {
        const tmpLines = [
            [38.994714, 117.312346],
            [38.994718, 117.311841],
            [38.994705, 117.310769],
            [38.994737, 117.308687],
            [38.994652, 117.306983],
            [38.994739, 117.305572],
            [38.994683, 117.304799],
            [38.994818, 117.304252],
            [38.994829, 117.303495],
            [38.995348, 117.302849],
            [38.996620, 117.301856],
            [38.997441, 117.302409],
            [38.997983, 117.304313],
            [38.998079, 117.304921],
            [38.997937, 117.305591],
            [38.997991, 117.307227],
            [38.998045, 117.308708],
            [38.998008, 117.310763],
            [38.997923, 117.311627],
            [38.997912, 117.312227],
            [38.99775, 117.312549],
            [38.997462, 117.312683],
            [38.996399, 117.313015],
            [38.995431, 117.312769],
            [38.994998, 117.31257],
        ];
        const tmpLines2 = [[38.994714, 117.312346],
            [38.994714863232176, 117.31231620362377],
            [38.99471180619536, 117.31230024303322],
            [38.9947145479771, 117.31227444458877],
            [38.994722558976164, 117.31224236453609],
            [38.99472557415013, 117.31222341410833],
            [38.99471908017569, 117.3121920770027],
            [38.994722976423176, 117.31217077096535],
            [38.99472029565387, 117.3121464469709],
            [38.994725993047055, 117.3121143669842],
            [38.99473183788456, 117.31209484343135],
            [38.99472419261533, 117.31206811225574],
            [38.99473480196079, 117.31203933982461],
            [38.99473190851958, 117.31202185869087],
            [38.99472837722429, 117.3119947220116],
            [38.99473236638981, 117.31196791099113],
            [38.99473638002232, 117.31193774090374],
            [38.99473448346652, 117.3119182339434],
            [38.994733904163056, 117.31188905148339],
            [38.99473659490049, 117.31186470885352],
            [38.994741, 117.311841],
            [38.99474407688592, 117.31179125905989],
            [38.99473815611744, 117.31173350604435],
            [38.99473366960358, 117.31168243421152],
            [38.99473186154976, 117.31162638760105],
            [38.99473225089717, 117.31156912013238],
            [38.99472974721655, 117.31151595827258],
            [38.99472912388184, 117.31146548280832],
            [38.99472896593914, 117.31141421017274],
            [38.9947281722161, 117.31136233190227],
            [38.9947231010084, 117.31130957399773],
            [38.99471623646386, 117.31125591151574],
            [38.99471794952915, 117.31119869405306],
            [38.99472058893537, 117.31114462382864],
            [38.99471572128034, 117.31108625956543],
            [38.9947117681077, 117.31103327706121],
            [38.99471143744653, 117.31098307495544],
            [38.99471171007948, 117.31092680367914],
            [38.99470830025084, 117.31087370663732],
            [38.99470846449136, 117.31082156456019],
            [38.994705, 117.310769],
            [38.99470452926243, 117.31066270634112],
            [38.99470454822658, 117.31056306077707],
            [38.99470667992757, 117.31045772172708],
            [38.994709752055286, 117.31035417781368],
            [38.99470848145273, 117.31025034823678],
            [38.99471428695606, 117.31014291346715],
            [38.99471329079343, 117.31003614130282],
            [38.994720732370524, 117.30994029550469],
            [38.994723699107475, 117.30982915354356],
            [38.99471663909214, 117.30972835099158],
            [38.99471864239951, 117.30962750523264],
            [38.994725546955955, 117.30951960503006],
            [38.99472482154084, 117.30941490251446],
            [38.9947281501624, 117.30931200842818],
            [38.99472662459695, 117.30921228590137],
            [38.99473145713287, 117.30910108457596],
            [38.99472731616206, 117.30899907099754],
            [38.99472998156639, 117.30889703226241],
            [38.99473580525412, 117.30878742490829],
            [38.994737, 117.308687],
            [38.99473169267383, 117.3086027493038],
            [38.994729851755395, 117.30851375625018],
            [38.99472856106689, 117.30842672374649],
            [38.99472080589436, 117.30834120888795],
            [38.99471691304913, 117.30825889453345],
            [38.99471649258843, 117.30817602188031],
            [38.99470961869276, 117.30809559231585],
            [38.994699055488674, 117.30800278970077],
            [38.99469833483683, 117.3079216138114],
            [38.99469901270016, 117.30783150947039],
            [38.994688420347074, 117.30775416004981],
            [38.994688713571556, 117.30765986240222],
            [38.99467967252161, 117.30758030182453],
            [38.994677383779496, 117.3074941088532],
            [38.99466849754491, 117.30740937298562],
            [38.994664048438516, 117.30732698279309],
            [38.99466915153604, 117.30723859346516],
            [38.99466148672058, 117.30715243153826],
            [38.99465447186455, 117.30706593791112],
            [38.994652, 117.306983],
            [38.9946533648711, 117.30690994380666],
            [38.99466073096743, 117.30684388189724],
            [38.99466470375415, 117.30677461383777],
            [38.99467148352389, 117.30670498009589],
            [38.99467113297244, 117.30663393448012],
            [38.994678477995265, 117.30655475568908],
            [38.99468526195555, 117.30648445431565],
            [38.994690096612466, 117.30641398964383],
            [38.994694025074786, 117.30634425096272],
            [38.99469843862822, 117.30627909065834],
            [38.99469716993396, 117.30620932576957],
            [38.994703004232825, 117.30613829072843],
            [38.99471087645901, 117.30606832802243],
            [38.99471251419126, 117.3059981777231],
            [38.994720055937435, 117.30592763124798],
            [38.99472087495742, 117.3058500809625],
            [38.99472724494394, 117.30578449359597],
            [38.99473013116294, 117.30571473492688],
            [38.994739563174875, 117.30564423537065],
            [38.994739, 117.305572],
            [38.994731953505564, 117.30552930864589],
            [38.99473377031177, 117.30549530517165],
            [38.99473032637192, 117.30545259405005],
            [38.994722925007274, 117.3054191601491],
            [38.994729905770576, 117.30538317329675],
            [38.99472515173202, 117.30534243088333],
            [38.99472336140502, 117.30530630187444],
            [38.994713640918285, 117.30526331832684],
            [38.99471165739511, 117.30522155092109],
            [38.994709876757184, 117.30518354051482],
            [38.994703842271434, 117.30515008035526],
            [38.99470321357786, 117.30511159723883],
            [38.994705226523315, 117.30507399867548],
            [38.99470268505097, 117.30503261592123],
            [38.99469596546267, 117.30499004557207],
            [38.994691462885946, 117.3049489909299],
            [38.994686890097206, 117.30491226999565],
            [38.99469354086118, 117.30487857256436],
            [38.99468330306081, 117.30484083628936],
            [38.994683, 117.304799],
            [38.99468495278549, 117.3047724631039],
            [38.99469518012374, 117.30474512992312],
            [38.994706285867565, 117.3047139158768],
            [38.99471136594903, 117.30468743423853],
            [38.99471346057508, 117.30466625833049],
            [38.99472301239035, 117.30463419592454],
            [38.99472547567416, 117.30460386419706],
            [38.99474041461528, 117.30457785626407],
            [38.99473919487975, 117.3045509622282],
            [38.994749582905044, 117.30452816519401],
            [38.9947541670917, 117.30450313584572],
            [38.994764601155, 117.30446858923652],
            [38.994771101847185, 117.3044484064329],
            [38.99477908725739, 117.30441897182564],
            [38.99478133163519, 117.30438557246677],
            [38.99479292246335, 117.30436260180201],
            [38.99480034653327, 117.30433417443595],
            [38.994800475469624, 117.30430346764663],
            [38.99480796914876, 117.30428023940026],
            [38.994818, 117.304252],
            [38.994820752986435, 117.30420959572042],
            [38.99481832814781, 117.30417564688123],
            [38.994822500100355, 117.30413372697788],
            [38.99481998009523, 117.30409607822536],
            [38.99482031676328, 117.30406064083542],
            [38.99481882279784, 117.30402149752243],
            [38.994822780631274, 117.30398818251663],
            [38.994825087135695, 117.30394485808485],
            [38.99482307375297, 117.30391125980161],
            [38.994825618282704, 117.30386993868991],
            [38.99482295304176, 117.30383861145573],
            [38.994820811970904, 117.30380131880432],
            [38.9948279521025, 117.30376489102397],
            [38.99482563833045, 117.30372649411466],
            [38.9948263905559, 117.30368906984897],
            [38.994824383055025, 117.30364607699383],
            [38.99482763753854, 117.30361049977809],
            [38.994827413312336, 117.30357176809501],
            [38.99482723185843, 117.30352812173423],
            [38.994829, 117.303495],
            [38.99485604448684, 117.3034601597043],
            [38.99488167648045, 117.30342578807173],
            [38.99490847167314, 117.30339346761885],
            [38.99492948256915, 117.30336577819315],
            [38.994963054709906, 117.30333363010054],
            [38.99498459820877, 117.30330331873714],
            [38.99500691474971, 117.3032685894669],
            [38.995032698160365, 117.30323968533936],
            [38.99506080820932, 117.30320488885144],
            [38.995086299835705, 117.30317208130138],
            [38.995110814819135, 117.30314366734267],
            [38.9951399623055, 117.3031060624489],
            [38.995167017559524, 117.30307461135754],
            [38.99519144796935, 117.3030396928906],
            [38.99522140476166, 117.30300751709657],
            [38.99524644835217, 117.30297949505537],
            [38.99526548589299, 117.30294123592125],
            [38.99529353373386, 117.30291429943898],
            [38.995324619082496, 117.30287801425827],
            [38.995348, 117.302849],
            [38.995415012993554, 117.3028030367777],
            [38.99547972436766, 117.30275456024151],
            [38.995542221077635, 117.30269772221565],
            [38.99560079298377, 117.30264986244845],
            [38.99566156358521, 117.30260003630455],
            [38.99572964075339, 117.3025511371733],
            [38.995794884274595, 117.30250555440803],
            [38.9958524485439, 117.30245089030231],
            [38.99592539171231, 117.30240106689055],
            [38.99598384370275, 117.30235460404936],
            [38.996043272604815, 117.30229834363824],
            [38.99610625593915, 117.3022514593388],
            [38.996179642206044, 117.30220490437462],
            [38.996233829511, 117.30214993691258],
            [38.996303034966, 117.30210609348461],
            [38.99637000989778, 117.30204965479365],
            [38.99643342473537, 117.30200791688779],
            [38.99649765831334, 117.30195966361823],
            [38.99655735226077, 117.30190216293661],
            [38.99662, 117.301856],
            [38.99665843928553, 117.3018799188959],
            [38.99670136115758, 117.30190695296676],
            [38.996744492084524, 117.30193673881632],
            [38.99678520613132, 117.3019629596425],
            [38.99683018881869, 117.30199035121458],
            [38.9968626594977, 117.3020209228578],
            [38.99690934299284, 117.30205051047895],
            [38.996952531778895, 117.30208155673603],
            [38.99698772456264, 117.30210336658408],
            [38.99703189865464, 117.30213220154327],
            [38.99706907950935, 117.30216467619302],
            [38.997110252645854, 117.30219041812343],
            [38.99714955905918, 117.30221753424607],
            [38.997190433553435, 117.30224203925148],
            [38.997240223834304, 117.30226808760997],
            [38.99728026059326, 117.30229904687364],
            [38.99731530219656, 117.30232346748465],
            [38.99736329851294, 117.30235727501251],
            [38.99739700602752, 117.30237855457418],
            [38.997441, 117.302409],
            [38.997469522964394, 117.30250051754757],
            [38.99749926520357, 117.30259856847641],
            [38.99751858632697, 117.30269064089615],
            [38.99755332021463, 117.30278743058109],
            [38.997572355416224, 117.30288497290724],
            [38.99760647219074, 117.30298281798852],
            [38.997627354679395, 117.30307756176323],
            [38.997654810401315, 117.30317288170933],
            [38.997681523030714, 117.30327037503373],
            [38.99771262809127, 117.30336067093124],
            [38.99774381519015, 117.30345125812073],
            [38.997764858343, 117.30355213051773],
            [38.99778853511108, 117.30364677541583],
            [38.99782136120617, 117.30373766779907],
            [38.997850060779435, 117.30383855053516],
            [38.99787500392379, 117.3039329681538],
            [38.997905832597496, 117.30402367745913],
            [38.9979262684364, 117.30412162168444],
            [38.99795366220957, 117.3042139102419],
            [38.997983, 117.304313],
            [38.99798397785758, 117.30434115134533],
            [38.99799686683156, 117.30437604229606],
            [38.99799984081382, 117.30440354297983],
            [38.99799827478629, 117.30443750631063],
            [38.99800435512789, 117.30446851827082],
            [38.99800933733111, 117.30449145411028],
            [38.99801798467862, 117.30452641637024],
            [38.99801927324077, 117.30456065637762],
            [38.9980216124133, 117.30459098866297],
            [38.998032323008, 117.30461608136571],
            [38.998037461306104, 117.30465019262653],
            [38.998041595694694, 117.30467682323574],
            [38.99805026323749, 117.30470963446463],
            [38.998054536269954, 117.30473545492826],
            [38.99805239716379, 117.30477137865348],
            [38.998063092786516, 117.3047969676233],
            [38.99806441996753, 117.304827586456],
            [38.99807382908104, 117.30486318199358],
            [38.99807013439267, 117.30489435927193],
            [38.998079, 117.304921],
            [38.998071408282094, 117.3049537592894],
            [38.99806680028189, 117.30498311991188],
            [38.99806187081088, 117.30502361730767],
            [38.99805396651004, 117.30505204448149],
            [38.9980427619394, 117.30509229315876],
            [38.998036524514866, 117.30511993775048],
            [38.99802796256235, 117.3051522071544],
            [38.99801782133355, 117.30518869737556],
            [38.99801698168838, 117.30521781796888],
            [38.99800758258169, 117.30525655848399],
            [38.99799916766316, 117.30529283054199],
            [38.997997431772895, 117.30532434163001],
            [38.99799162645921, 117.30535838374135],
            [38.99797487921813, 117.30539182709764],
            [38.997976744534604, 117.30541865892963],
            [38.997963898981425, 117.305455914782],
            [38.997961955400456, 117.30548650740043],
            [38.997951678114894, 117.30552781324037],
            [38.99794187186743, 117.30555464293782],
            [38.997937, 117.305591],
            [38.99793806547506, 117.30567502531756],
            [38.99794581715439, 117.30575281268943],
            [38.9979488502292, 117.30583202946201],
            [38.99794858210727, 117.3059144806301],
            [38.99795536562994, 117.30599764729773],
            [38.997951009224586, 117.30608268264149],
            [38.99795149334219, 117.3061593096499],
            [38.997958159646814, 117.30624417964367],
            [38.99795993835315, 117.30632333907973],
            [38.99796636350525, 117.30641030951283],
            [38.99796393301628, 117.30649117020981],
            [38.99797252175849, 117.30657652296586],
            [38.997969365816665, 117.30665692937622],
            [38.997979686536155, 117.30674081577175],
            [38.9979743639281, 117.30681766229641],
            [38.99797980168459, 117.30690133483509],
            [38.99797867303895, 117.30698157766868],
            [38.99798247796773, 117.30706163919756],
            [38.997984973684005, 117.30714467920475],
            [38.997991, 117.307227],
            [38.99799395506334, 117.30729615811202],
            [38.997993013146704, 117.30737281754503],
            [38.99799953309914, 117.30745195329956],
            [38.99800071728822, 117.30752182512326],
            [38.99800434669785, 117.30760176526807],
            [38.998008133169, 117.30766817855161],
            [38.99800539941907, 117.30775012560468],
            [38.99801161998881, 117.30782190010952],
            [38.99801045600094, 117.30789489885899],
            [38.998016301223615, 117.30796484080611],
            [38.99801966745583, 117.30804336888488],
            [38.99802599691385, 117.30811410427542],
            [38.99803004361477, 117.30818662531263],
            [38.99802488767557, 117.30826055340125],
            [38.998033389825224, 117.3083420774164],
            [38.99803416038229, 117.3084154228224],
            [38.99803552597638, 117.30849081826003],
            [38.99803623562352, 117.30855723043543],
            [38.99804015809951, 117.30862908440271],
            [38.998045, 117.308708],
            [38.998039983405164, 117.3088134210046],
            [38.99803660514161, 117.3089112601172],
            [38.998044424903256, 117.30901316097005],
            [38.99803335779364, 117.30912235274425],
            [38.99803987456933, 117.30922546095611],
            [38.99803002881988, 117.30932195728694],
            [38.998029829392635, 117.3094259245634],
            [38.99803106900772, 117.30953324255483],
            [38.99802868386654, 117.30963616923525],
            [38.99802978575384, 117.30973082271106],
            [38.998022250000886, 117.30984008920436],
            [38.99802558627465, 117.30993943238441],
            [38.99802129822033, 117.31004240477654],
            [38.998022015969156, 117.31014928772801],
            [38.99801818973091, 117.31024457632972],
            [38.99801205765965, 117.31035056226624],
            [38.99801010711849, 117.31045416563352],
            [38.99801610569766, 117.31055732824788],
            [38.99800935293848, 117.31065647690544],
            [38.998008, 117.310763],
            [38.99800335114179, 117.31080739508509],
            [38.997998838371586, 117.31084480984399],
            [38.99799400099355, 117.31089052023937],
            [38.9979862293618, 117.31093753330042],
            [38.99798650663478, 117.31098032281722],
            [38.997981341058804, 117.31102536512445],
            [38.99797454660426, 117.31106057770512],
            [38.997972458391075, 117.31110672358591],
            [38.9979739784516, 117.31115175353443],
            [38.99796726707057, 117.31119189688286],
            [38.99795768141729, 117.31123821775991],
            [38.997955164747296, 117.31127948938506],
            [38.99794950436006, 117.31131989103797],
            [38.997945730755724, 117.31137255469042],
            [38.99793978644481, 117.31140922221485],
            [38.99794281793454, 117.31145330279682],
            [38.99793513804382, 117.31150202085117],
            [38.99793402559094, 117.3115450019632],
            [38.99792590539016, 117.31158618488836],
            [38.997923, 117.311627],
            [38.997921057634755, 117.31165995869274],
            [38.99792078451653, 117.31168245474235],
            [38.99792173775146, 117.31171879402726],
            [38.997918350464104, 117.31174389578524],
            [38.99791873378164, 117.31177803023053],
            [38.997924122995904, 117.31180312765916],
            [38.99791426200611, 117.31183862107659],
            [38.997923143344984, 117.31186477130623],
            [38.997922812979674, 117.31189856503349],
            [38.99792038616218, 117.3119290222887],
            [38.99791948264249, 117.31195804750142],
            [38.99791891477742, 117.3119831454021],
            [38.99791459468786, 117.3120132994529],
            [38.99791222131782, 117.31204345466116],
            [38.99791304050412, 117.3120790226654],
            [38.99791468286485, 117.31210800418071],
            [38.99791025424066, 117.31213526871088],
            [38.997910200634315, 117.31216912631423],
            [38.997913536450625, 117.31219400140895],
            [38.997912, 117.312227],
            [38.997904435516965, 117.3122430848286],
            [38.99789215752303, 117.31225646219032],
            [38.99788730750216, 117.31227237092713],
            [38.9978747272338, 117.31229043416175],
            [38.997875612072384, 117.312304667886],
            [38.99785857941816, 117.31232491716423],
            [38.9978510985923, 117.31233495823555],
            [38.99784672877816, 117.31235188406156],
            [38.997838362890285, 117.31237300686784],
            [38.99782652995815, 117.31239154660145],
            [38.997824769565185, 117.31240444623205],
            [38.997817543455824, 117.3124203178001],
            [38.99781120549374, 117.31244036819118],
            [38.99779587256307, 117.31245700474418],
            [38.997792576196936, 117.31246652176806],
            [38.997779141445115, 117.31248571558508],
            [38.99777747410278, 117.31249702238523],
            [38.99776703018, 117.31251746848774],
            [38.997753272710625, 117.31253125157266],
            [38.99775, 117.312549],
            [38.99773957079378, 117.31255530255838],
            [38.99772032222228, 117.31255786583716],
            [38.99770360077061, 117.31256819046021],
            [38.997690658429846, 117.31257596935963],
            [38.99768068643051, 117.31257982505504],
            [38.99766665597454, 117.3125910300324],
            [38.99764944230202, 117.31259295427792],
            [38.99763967727817, 117.31259919972452],
            [38.99762520356613, 117.31261400841151],
            [38.99760618958279, 117.31262059496032],
            [38.997595413668996, 117.31262629832021],
            [38.99757542023156, 117.31263436572756],
            [38.99755938448642, 117.31263705500454],
            [38.99755115589148, 117.31263986728011],
            [38.99753769379899, 117.31264495314218],
            [38.99751909416746, 117.31265632750404],
            [38.997505561540976, 117.31266304043993],
            [38.997489430195046, 117.31266690656423],
            [38.99747494181087, 117.31267799170492],
            [38.997462, 117.312683],
            [38.99741242639223, 117.31270361491357],
            [38.99735659427461, 117.31271256021056],
            [38.99729774272754, 117.31273551556974],
            [38.997254186813414, 117.31274714681172],
            [38.99719524871383, 117.31276242484154],
            [38.99714471832338, 117.31277778669983],
            [38.9970884740838, 117.31280183991008],
            [38.997032256391776, 117.31281888616564],
            [38.996980587362664, 117.31282936519519],
            [38.996930015681045, 117.31285065863841],
            [38.996879201268996, 117.312860720823],
            [38.996820186689796, 117.31288643726434],
            [38.99677453033875, 117.31289652104306],
            [38.99671445640005, 117.31291650422823],
            [38.99666018283452, 117.31293542120113],
            [38.99660737160265, 117.31294507185328],
            [38.996562888744435, 117.31296667444084],
            [38.9965086765882, 117.31298241278523],
            [38.99644715263304, 117.31299477625339],
            [38.996399, 117.313015],
            [38.99634929908504, 117.31300201546041],
            [38.99630447732717, 117.312986986794],
            [38.99625088337924, 117.31297614921003],
            [38.996200944274065, 117.31296616320871],
            [38.99615691386925, 117.31295484530646],
            [38.9961047075718, 117.31293903277381],
            [38.996061313988214, 117.31292702856167],
            [38.996015382459255, 117.31291336952663],
            [38.99596531455282, 117.31290018243776],
            [38.995910533342986, 117.31289390453846],
            [38.99586481737741, 117.31288166496589],
            [38.99582050500121, 117.31286972247732],
            [38.99577155627739, 117.31285120605668],
            [38.99571727467042, 117.31283922067732],
            [38.99567350872143, 117.31283474423738],
            [38.99562613073762, 117.31281611550868],
            [38.995571818897645, 117.31280124343083],
            [38.99552840493432, 117.31279449286288],
            [38.99547682129298, 117.3127763251373],
            [38.995431, 117.312769],
            [38.9954049091374, 117.31275802237194],
            [38.99539029555825, 117.31274550122669],
            [38.99536730382513, 117.31274223354231],
            [38.99534078459186, 117.31273083856281],
            [38.99531993186013, 117.31271453796226],
            [38.99530131687583, 117.31271394662775],
            [38.995279421430176, 117.3126978104041],
            [38.99525297740079, 117.31269369315049],
            [38.99523572782713, 117.31267847342357],
            [38.99521309959903, 117.31267067511887],
            [38.99519174084836, 117.312656731412],
            [38.99516683171684, 117.31265183122811],
            [38.99514656089629, 117.31263735617392],
            [38.99512652370141, 117.31263226377645],
            [38.995101503162175, 117.31262299678016],
            [38.995082613138585, 117.31261017125485],
            [38.99506295251888, 117.31260230748538],
            [38.99504536711696, 117.3125905029071],
            [38.995022392092054, 117.31257662435762],
            [38.994998, 117.31257],
            [38.99498868253845, 117.3125606124091],
            [38.994966487073526, 117.31254577458711],
            [38.99495081990511, 117.31253876698689],
            [38.994937168309626, 117.31252830080606],
            [38.99492528545019, 117.31251398633889],
            [38.994913889059475, 117.31250023954095],
            [38.99489994781454, 117.31249155819691],
            [38.99488135074169, 117.31248171162011],
            [38.99486667754684, 117.31246847895437],
            [38.994857731538886, 117.31246257734551],
            [38.994838685392466, 117.31244525341047],
            [38.99482318342634, 117.31243348278922],
            [38.99480965621245, 117.31242625674108],
            [38.994801586727746, 117.3124141942849],
            [38.994787689783635, 117.31240586385798],
            [38.99477452404599, 117.3123931818871],
            [38.994751727079375, 117.312381013245],
            [38.99474603105562, 117.31237299512607],
            [38.99472769266846, 117.31235522898686],
            [38.994714, 117.312346],

        ]
        L.polyline(tmpLines2, {color: "red"}).addTo(map);
    }

    createMap() {
        map = L.map("map", {
            preferCanvas: true,
            renderer: L.canvas(),
            attributionControl: false,
            scrollWheelZoom: false,
        }).setView(this.nowCenter, this.zoom);

        map.zoomControl.setPosition("topright");

        this.baseMapsSwitcherPlugin()

        // 点击输出经纬度
        map.on("click", (e) => {
            console.log(`click:${e.latlng}, center:${map.getCenter()}`);
            ElMessage({
                message: `click:${e.latlng}, center:${map.getCenter()}`,
                type: 'success'
            })
            if (this.tmpMarker) {
                this.tmpMarker.remove();
            }
            this.tmpMarker = L.marker(e.latlng).addTo(map);
        });
        // this.doSomeTest();

    }

    baseMapsSwitcherPlugin() {
        new L.basemapsSwitcher(
            [
                {
                    layer: L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
                        zoom: this.zoom,
                        maxZoom: this.maxZoom,
                        minZoom: this.minZoom,
                    }).addTo(map),
                    icon: "/light.png",
                    name: "Light",
                },
                {
                    layer: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
                        zoom: this.zoom,
                        maxZoom: this.maxZoom,
                        minZoom: this.minZoom,
                    }),
                    icon: "/dark.png",
                    name: "Dark",
                },
                {
                    layer: L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", {
                        zoom: this.zoom,
                        maxZoom: this.maxZoom,
                        minZoom: this.minZoom,
                    }),
                    icon: "/voyager.png",
                    name: "Voyager",
                },
            ],
            {position: "bottomright"}
        ).addTo(map);
    }

    toCenter() {
        let latSum = 0;
        let lngSum = 0;
        let count = 0;
        for (const key in movers) {
            const mover = movers[key];
            if (mover.marker) {
                const loc = mover.marker.getMarkers()[0].getLatLng();
                latSum += loc.lat;
                lngSum += loc.lng;
                count++;
            }
        }
        if (count > 0) {
            this.nowCenter = [latSum / count, lngSum / count];
        }
        map.panTo(this.nowCenter, map.getZoom());
    }


}

myMap = new MyMap();

// ========================= 地图控制 =========================


class MapController {
    constructor() {
        this.sidebar = null;
        this.sidebarPlugin();
        this.toCenterPlugin();
    }


    toCenterPlugin() {
        L.Control.ResetCenter = L.Control.extend({
            options: {
                position: "topright",
            },
            initialize: function (options) {
                L.Util.extend(this.options, options);
            },
            onAdd: function (map) {
                const container = L.DomUtil.create("div", "leaflet-bar leaflet-control leaflet-control-custom");
                container.style.backgroundColor = "white";
                container.style.backgroundRepeat = "no-repeat";
                container.style.backgroundPosition = "center";
                container.style.backgroundImage = "url(/position.svg)";
                container.style.backgroundSize = "22px 22px";
                container.style.width = "30px";
                container.style.height = "30px";
                container.onmouseover = () => {
                    container.style.backgroundColor = "#f4f4f4";
                };
                container.onmouseout = () => {
                    container.style.backgroundColor = "white";
                };

                container.onclick = () => {
                    myMap.toCenter();
                };
                return container;
            },
        });
        L.control.resetCenter = function (opts) {
            return new L.Control.ResetCenter(opts);
        };
        L.control.resetCenter({position: "topright"}).addTo(map);
    }

    sidebarPlugin() {
        this.sidebar = L.control
            .sidebar({
                autopan: true,
                container: "sidebar",
            })
            .addTo(map);
    }
}

// ========================= 移动目标 =========================

class Mover {
    constructor(id, type) {
        this.startRealFrame = 0;
        this.frameLength = 2000;

        // startRealFrame 到 (startRealFrame + frameLength) 范围内的所有数据
        this.locList = [];
        this.velocityList = [];
        this.accelerationList = [];

        this.id = id;
        this.marker = null;
        this.icon = (type === 0) ? L.icon({
            iconUrl: "/ship.svg",
            iconSize: [16, 16],
        }) : (type === 1 ? L.icon({
            iconUrl: "/uav.svg",
            iconSize: [16, 16],
        }) : L.icon({
            iconUrl: "/ugv.svg",
            iconSize: [16, 16],
        }));
        this.moveDuration = 500;

        this.hasPolyLines = false;
        this.maxPolyLineLength = 200;
        this.polyLines = [];

        this.hasStaticPolyLines = false;
        this.staticPolyLines = [];
        this.staticMarkers = [];

        this.colors = [
            "#313695",
            "#4575B4",
            "#74ADD1",
            "#ABD9E9",
            "#E0F3F8",
            "#FEE090",
            "#FDAE61",
            "#F46D43",
            "#D73027",
            "#A50026"
        ];

        this.debug = globalDebug
        this.openOffset = false;
        this.offsetLatitude = 0;
        this.offsetLongitude = 0;
        this.offsetLatitudeStep = 0.0000;
        this.offsetLongitudeStep = 0.0002;


    }

    setFrameLength(newFrameLength) {
        newFrameLength = Math.floor(newFrameLength / motionRugs.resizeScale)
        if (newFrameLength < this.frameLength) {
            this.locList = this.locList.slice(0, newFrameLength);
            this.velocityList = this.velocityList.slice(0, newFrameLength);
            this.accelerationList = this.accelerationList.slice(0, newFrameLength);
        }
        this.frameLength = newFrameLength;
    }

    /**
     * 当接收到新的数据时，调用此方法，保证数据量在一定的范围内，并且更新marker，[由App.vue保证到这里的数据都是按序的]
     * @param loc[lat,lng] {[number, number]} 位置
     * @param frameNum {number} 帧号
     * @param velocity {number} 速度
     * @param acceleration {number} 加速度
     */
    newData(loc, frameNum, velocity, acceleration) {

        if (loc[0] <= 36.109676 && loc[1] >= -86.721864 && this.debug) {
            if (this.openOffset) {
                loc[0] -= this.offsetLatitude;
                loc[1] -= this.offsetLongitude;

                this.offsetLatitude += this.offsetLatitudeStep;
                this.offsetLongitude += this.offsetLongitudeStep;
            } else {
                this.openOffset = true;
            }
        }

        this.locList.push(loc);
        this.velocityList.push(velocity);
        this.accelerationList.push(acceleration);
        if (this.locList.length > this.frameLength) {
            this.locList.shift();
            this.velocityList.shift();
            this.accelerationList.shift();
            this.startRealFrame++;
        }

        if (this.locList.length >= 2) {
            this.updateMarker();
        }
    }

    /**
     * 更新marker
     */
    updateMarker() {
        if (this.marker) {
            this.marker.remove();
        }

        this.marker = L.motion.polyline(
            [this.locList[this.locList.length - 2], this.locList[this.locList.length - 1]],
            {
                color: "transparent",
            },
            {
                auto: true,
                duration: this.moveDuration,
                easing: L.Motion.Ease.linear,
            },
            {
                removeOnEnd: false,
                showMarker: true,
                icon: this.icon,
            }
        );

        this.marker.addTo(map);

        this.drawPolyLines();
    }

    changeIcon(iconName) {
        if (this.marker) {

            this.marker.getMarkers()[0].setIcon(L.icon({
                iconUrl: iconName,
                iconSize: [24, 24],
            }));
        }
    }

    setHasPolyLines(hasPolyLines) {
        console.log(`id: ${this.id}, setHasPolyLines: ${hasPolyLines}`)
        this.hasPolyLines = hasPolyLines;
        if (!this.hasPolyLines) {
            this.clearPolyLines();
        } else {
            this.drawPolyLines();
        }
    }

    clearPolyLines() {
        // console.log(`id: ${this.id}, clearPolyLines`)
        this.polyLines.forEach(polyLine => {
            polyLine.remove();
        })
        this.polyLines = [];
    }

    drawPolyLines(from = 0, to = motionRugsDataset.orderedData.length - 1) {
        if (!this.hasPolyLines) {
            return;
        }
        this.clearPolyLines();
        for (let i = Math.max(from, motionRugsDataset.orderedData.length - 1 - this.maxPolyLineLength); i < to; i++) {
            // 找到这个id在motionRugs.orderedData[i]中的索引
            let idx;
            for (let tmp = 0; tmp < motionRugsDataset.orderedData[i].length; tmp++) {
                if (motionRugsDataset.orderedData[i][tmp].TrackID === this.id) {
                    idx = tmp;
                    break;
                }
            }

            const colorIdx = motionRugsDataset.orderedData[i][idx].colorIdx;
            const polyLine = L.polyline([this.locList[i], this.locList[i + 1]], {
                color: this.colors[colorIdx],
                weight: 4,
                // stroke: false,
            });
            polyLine.addTo(map);
            this.polyLines.push(polyLine);
        }
    }


    addStaticPolyLine(frame) {
        if (frame < 0 || frame >= this.locList.length - 1) {
            return;
        }
        // 找到这个id在motionRugs.orderedData[i]中的索引
        let idx;
        for (let tmp = 0; tmp < motionRugsDataset.orderedData[frame].length; tmp++) {
            if (motionRugsDataset.orderedData[frame][tmp].TrackID === this.id) {
                idx = tmp;
                break;
            }
        }

        const colorIdx = motionRugsDataset.orderedData[frame][idx].colorIdx;
        const polyLine = L.polyline([this.locList[frame], this.locList[frame + 1]], {
            color: this.colors[colorIdx],
            weight: 4,
            // stroke: false,
        }).arrowheads();
        polyLine.addTo(map);
        this.staticPolyLines.push(polyLine);

    }


    clearStatic() {
        this.staticPolyLines.forEach(polyLine => {
            polyLine.remove();
        })
        this.staticPolyLines = [];
        this.staticMarkers.forEach(marker => {
            marker.remove();
        })
        this.staticMarkers = [];
    }
}


// ========================= MotionRugs =========================
class MotionRugs {
    constructor() {
        this.canvas = null;
        this.ctx = null;
        this.resizeScale = 6;

        this.feature = globalFeature;

        this.rawImageData = null;
        this.maskedImageData = null;
        this.resizedImageData = null;

        this.hasLineMask = false;
        this.lineMaskID = -1;
        this.lineMaskSwitch = true;

        this.hasRecMask = false;
        this.recMaskID = -1;
        this.recMaskYPos = -1;
        this.recMaskFrame = -1;
        this.recMaskWidth = 3;
        this.recMaskHeight = 3;
        this.recMaskThreshold = 1;
        this.recMaskColorIdx = -1;
        this.recMaskSwitch = true;

        this.colors = [
            "#313695",
            "#4575B4",
            "#74ADD1",
            "#ABD9E9",
            "#E0F3F8",
            "#FEE090",
            "#FDAE61",
            "#F46D43",
            "#D73027",
            "#A50026"
        ];
        this.contrastingColors = [
            "#CEC96A",
            "#BA8A4B",
            "#8B522E",
            "#542616",
            "#1F0C07",
            "#011F6F",
            "#02519E",
            "#0B92BC",
            "#28CFD8",
            "#5AFFD9"
        ];
    }

    updateData() {
        this.generateRawImageData(this.feature);
        this.generateMaskedImageData();

        this.resizedImageData = resizeImageData(this.maskedImageData, this.maskedImageData.width * motionRugs.resizeScale, this.maskedImageData.height * motionRugs.resizeScale);
        this.ctx.putImageData(this.resizedImageData, 0, 0);
    }

    generateRawImageData(feature = "Velocity") {
        const tempImageData = new ImageData(motionRugsDataset.orderedData.length, motionRugsDataset.orderedData[0].length);
        for (let x = 0; x < motionRugsDataset.orderedData.length; x++) {
            for (let y = 0; y < motionRugsDataset.orderedData[x].length; y++) {
                const colorIdx = this.getColorIdx(motionRugsDataset.orderedData[x][y][feature])
                const color = this.colors[colorIdx];
                const idx = (y * motionRugsDataset.orderedData.length + x) * 4;
                tempImageData.data[idx] = parseInt(color.substring(1, 3), 16);
                tempImageData.data[idx + 1] = parseInt(color.substring(3, 5), 16);
                tempImageData.data[idx + 2] = parseInt(color.substring(5, 7), 16);
                tempImageData.data[idx + 3] = 255;

                motionRugsDataset.orderedData[x][y].colorIdx = colorIdx;
            }
        }

        this.rawImageData = tempImageData;
    }

    getColorIdx = (featureValue) => {
        if (featureValue < motionRugsDataset.deciles[0]) {
            return 0;
        } else if (featureValue >= motionRugsDataset.deciles[8]) {
            return 9;
        } else {
            for (let i = 0; i <= 7; i++) {
                if (featureValue >= motionRugsDataset.deciles[i] && featureValue < motionRugsDataset.deciles[i + 1]) {
                    return i + 1;
                }
            }
        }
    }

    generateMaskedImageData() {
        this.maskedImageData = this.rawImageData;

        // this.clearAllMask();
        if (this.addLineMask()) {
            return;
        }
        if (this.addRecMask()) {
            return;
        }
    }


    setHasLineMask(flag, frame = 0, pos = -1) {
        this.hasLineMask = flag;
        this.hasRecMask = false;
        if (pos !== -1) {
            this.lineMaskID = motionRugsDataset.orderedToID[frame][pos];
            this.lineMaskSwitch = true;
        } else {
            this.lineMaskID = -1;
        }

        for (let i = 0; i < Object.keys(movers).length; i++) {
            movers[Object.keys(movers)[i]].setHasPolyLines(false);
        }
        if (this.hasLineMask) {
            movers[this.lineMaskID].setHasPolyLines(flag);
        }
        this.updateData();
    }

    addLineMask() {
        if (!this.hasLineMask) {
            return false;
        }
        if (!this.lineMaskSwitch) {
            this.lineMaskSwitch = true;
            return true;
        } else {
            this.lineMaskSwitch = false;
        }

        for (let i = 0; i < motionRugsDataset.orderedData.length; i++) {
            for (let j = 0; j < motionRugsDataset.orderedData[i].length; j++) {
                if (motionRugsDataset.orderedData[i][j].TrackID === this.lineMaskID) {
                    const idx = (j * motionRugsDataset.orderedData.length + i) * 4;
                    const idxTop = ((j - 1) * motionRugsDataset.orderedData.length + i) * 4;
                    const idxBottom = ((j + 1) * motionRugsDataset.orderedData.length + i) * 4;

                    const colorIdx = this.getColorIdx(motionRugsDataset.orderedData[i][j][this.feature])

                    this.maskedImageData.data[idx] = 255;
                    this.maskedImageData.data[idx + 1] = 255;
                    this.maskedImageData.data[idx + 2] = 255;
                    this.maskedImageData.data[idx + 3] = 255;


                    // this.maskedImageData.data[idx] = parseInt(this.contrastingColors[colorIdx].substring(1, 3), 16);
                    // this.maskedImageData.data[idx + 1] = parseInt(this.contrastingColors[colorIdx].substring(3, 5), 16);
                    // this.maskedImageData.data[idx + 2] = parseInt(this.contrastingColors[colorIdx].substring(5, 7), 16);
                    // this.maskedImageData.data[idx + 3] = 255;
                    //
                    // if (j > 0) {
                    //     this.maskedImageData.data[idxTop] = parseInt(this.contrastingColors[colorIdx].substring(1, 3), 16);
                    //     this.maskedImageData.data[idxTop + 1] = parseInt(this.contrastingColors[colorIdx].substring(3, 5), 16);
                    //     this.maskedImageData.data[idxTop + 2] = parseInt(this.contrastingColors[colorIdx].substring(5, 7), 16);
                    //     this.maskedImageData.data[idxTop + 3] = 255;
                    // }
                    //
                    // if (j < motionRugsDataset.orderedData[i].length - 1) {
                    //     this.maskedImageData.data[idxBottom] = parseInt(this.contrastingColors[colorIdx].substring(1, 3), 16);
                    //     this.maskedImageData.data[idxBottom + 1] = parseInt(this.contrastingColors[colorIdx].substring(3, 5), 16);
                    //     this.maskedImageData.data[idxBottom + 2] = parseInt(this.contrastingColors[colorIdx].substring(5, 7), 16);
                    //     this.maskedImageData.data[idxBottom + 3] = 255;
                    // }
                    break;
                }
            }
        }
        return true;
    }

    setHasRecMask(flag, frame = 0, pos = -1) {
        this.hasRecMask = flag;
        this.hasLineMask = false;
        if (pos !== -1) {
            this.recMaskID = motionRugsDataset.orderedToID[frame][pos];
            this.recMaskFrame = frame;
            this.recMaskYPos = pos;
            this.recMaskColorIdx = motionRugsDataset.orderedData[frame][pos].colorIdx;
            this.recMaskSwitch = true;
        } else {
            this.recMaskID = -1;
            this.recMaskFrame = -1;
            for (let i = 0; i < Object.keys(movers).length; i++) {
                movers[Object.keys(movers)[i]].clearStatic();
            }
        }
        this.updateData();
    }

    // TODO: 这里的颜色有问题
    addRecMask() {
        if (!this.hasRecMask) {
            return false;
        }

        if (!this.recMaskSwitch) {
            this.recMaskSwitch = true;
            return true;
        } else {
            this.recMaskSwitch = false;
        }

        for (let i = 0; i < Object.keys(movers).length; i++) {
            movers[Object.keys(movers)[i]].clearStatic();
        }

        const centerX = this.recMaskFrame;
        const centerY = this.recMaskYPos;
        const leftBound = Math.max(0, centerX - this.recMaskWidth);
        const rightBound = Math.min(motionRugsDataset.orderedData.length - 1, centerX + this.recMaskWidth);
        const topBound = Math.max(0, centerY - this.recMaskHeight);
        const bottomBound = Math.min(motionRugsDataset.orderedData[centerX].length - 1, centerY + this.recMaskHeight);
        for (let x = leftBound; x <= rightBound; x++) {
            for (let y = topBound; y <= bottomBound; y++) {
                if (Math.abs(motionRugsDataset.orderedData[centerX][centerY].colorIdx - motionRugsDataset.orderedData[x][y].colorIdx) <= this.recMaskThreshold) {
                    const idx = (y * motionRugsDataset.orderedData.length + x) * 4;
                    // this.maskedImageData.data[idx] = parseInt(this.contrastingColors[this.recMaskColorIdx].substring(1, 3), 16);
                    // this.maskedImageData.data[idx + 1] = parseInt(this.contrastingColors[this.recMaskColorIdx].substring(3, 5), 16);
                    // this.maskedImageData.data[idx + 2] = parseInt(this.contrastingColors[this.recMaskColorIdx].substring(5, 7), 16);
                    this.maskedImageData.data[idx] = parseInt(this.colors[this.recMaskColorIdx].substring(1, 3), 16);
                    this.maskedImageData.data[idx + 1] = parseInt(this.colors[this.recMaskColorIdx].substring(3, 5), 16);
                    this.maskedImageData.data[idx + 2] = parseInt(this.colors[this.recMaskColorIdx].substring(5, 7), 16);
                    this.maskedImageData.data[idx + 3] = 255;

                    try {
                        movers[motionRugsDataset.orderedToID[x][y]].addStaticPolyLine(x);
                    } catch (e) {
                        console.log(e, x, y, motionRugsDataset.orderedToID[x][y]);
                    }
                }
            }
        }

        return true;
    }

    clearAllMask() {
        this.setHasLineMask(false);
        this.setHasRecMask(false);
    }

}

motionRugs = new MotionRugs();

// ========================= Processor =========================
class MotionRugsDataset {
    constructor() {
        this.baseData = [];
        this.maxDataLength = 2000;
        this.orderedData = [];
        this.deciles = [];
        this.orderedToID = [];

        this.strategyName = globalStrategy;
        this.featureName = globalFeature;

        this.idxxx = [];
    }

    setMaxDataLength(maxDataLength) {
        this.maxDataLength = Math.floor(maxDataLength / motionRugs.resizeScale);
        ElMessage({
            message: "Max data length is set to " + this.maxDataLength,
            type: "success",
            duration: 1000
        });
    }

    newData(data) {
        this.baseData.push(data);
        if (this.baseData.length > this.maxDataLength) {
            this.baseData.shift();
            this.orderedData.shift();
            this.orderedToID.shift();
        }
        this.getOrderedData(this.strategyName);
        this.getDeciles(this.featureName);
        motionRugs.updateData();
    }

    // 对这一frame的数据（这帧上的切片）进行排序
    getOrderedData(strategyName = "zOrder", frame = this.baseData.length - 1) {
        if (frame < 0 || frame >= this.baseData.length) {
            return;
        }
        if (this.orderedData[frame]) {
            return this.orderedData[frame];
        }

        if (strategyName === "zOrder") {
            // console.time("zOrder");
            this.zOrder(frame);
            // console.timeEnd("zOrder");
        } else if (strategyName === "hilbertOrder") {
            // console.time("hilbertOrder");
            this.hilbertOrder(frame);
            // console.timeEnd("hilbertOrder");
        } else if (strategyName === "geoHashOrder") {
            // console.time("geoHashOrder");
            this.geoHashOrder(frame);
            // console.timeEnd("geoHashOrder");
        }

    }

    zOrder(frame) {
        const zOrderIndex = (lat, lon, id = -1) => {
            const BITS = 32; // 索引值的位数

            // 将经度值和纬度值映射到[0, 2^BITS-1]的整数范围内
            const latInt = Math.round((lat - 30) * (1 << (BITS - 10)));
            const lonInt = Math.round((lon + 180) * (1 << (BITS - 9)));

            let index = 0;
            for (let i = 0; i < BITS / 2; i++) {
                // 每次取一位经纬度坐标的二进制位，并将其交替组合成一个32位整数
                const bitMask = 1 << (BITS - i * 2 - 1);
                const latBit = latInt & bitMask ? 1 : 0;
                const lonBit = lonInt & bitMask ? 1 : 0;
                const interleavedBits = (latBit << 1) | lonBit;
                index |= interleavedBits << (BITS - i * 2 - 2);
            }
            // if (frame === 0) {
            //     this.idxxx.push([id, index]);
            //     this.idxxx.sort((a, b) => (a[1] - b[1]))
            //     // 去重
            //     for (let i = 0; i < this.idxxx.length - 1; i++) {
            //         if (this.idxxx[i][1] === this.idxxx[i + 1][1]) {
            //             this.idxxx.splice(i, 1);
            //             i--;
            //         }
            //     }
            //     console.log(this.idxxx.sort((a, b) => (a[1] - b[1])));
            // }
            return index;
        }
        this.orderedData[frame] = this.baseData[frame].sort((a, b) => {
            return zOrderIndex(a.LatitudeGPS, a.LongitudeGPS, a.TrackID) - zOrderIndex(b.LatitudeGPS, b.LongitudeGPS, b.TrackID);
        });

        this.orderedToID[frame] = this.orderedData[frame].map((d) => {
            return d.TrackID;
        });
    }

    hilbertOrder(frame) {
        const hilbertCurveIndex = (lat, lon, id = -1) => {
            lat = lat * 2000;
            lon = lon * 2000;

            const n = 65536; // 网格数量
            const latRange = [90, -90]; // 纬度范围
            const lonRange = [-180, 180]; // 经度范围

            // 将经纬度转换为网格索引
            const latIndex = Math.floor(((lat - latRange[1]) / (latRange[0] - latRange[1])) * n);
            const lonIndex = Math.floor(((lon - lonRange[0]) / (lonRange[1] - lonRange[0])) * n);

            // 将网格索引转换为希尔伯特曲线索引
            let index = 0;
            let mask = 1 << 15;
            for (let i = 0; i < 16; i++) {
                const hX = (latIndex & mask) > 0 ? 1 : 0;
                const hY = (lonIndex & mask) > 0 ? 1 : 0;
                index += mask * ((3 * hX) ^ hY);
                mask >>= 1;
            }
            mask = 1 << 31;
            for (let i = 16; i < 32; i++) {
                const hX = (latIndex & mask) > 0 ? 1 : 0;
                const hY = (lonIndex & mask) > 0 ? 1 : 0;
                index += mask * ((3 * hX) ^ hY);
                mask >>= 1;
            }
// if (frame === 0) {
//                 this.idxxx.push([id, index]);
//                 this.idxxx.sort((a, b) => (a[1] - b[1]))
//                 // 去重
//                 for (let i = 0; i < this.idxxx.length - 1; i++) {
//                     if (this.idxxx[i][1] === this.idxxx[i + 1][1]) {
//                         this.idxxx.splice(i, 1);
//                         i--;
//                     }
//                 }
//                 console.log(this.idxxx.sort((a, b) => (a[1] - b[1])));
//             }
            return index;
        }

        this.orderedData[frame] = this.baseData[frame].sort((a, b) => {
            return hilbertCurveIndex(a.LatitudeGPS, a.LongitudeGPS, a.TrackID) - hilbertCurveIndex(b.LatitudeGPS, b.LongitudeGPS, b.TrackID);
        });

        this.orderedToID[frame] = this.orderedData[frame].map((d) => {
            return d.TrackID;
        });
    }

    geoHashOrder(frame) {
        // 将经纬度转换为索引值
        const latLngToIndex = (lat, lng, id = -1) => {
            const LAT_RATIO = 1000000;
            const LNG_RATIO = 1000000;

            // 将经度和纬度转换为整数
            const latInt = Math.round(lat * LAT_RATIO);
            const lngInt = Math.round(lng * LNG_RATIO);

            // 将经度和纬度的整数值转换为二进制并拼接起来
            const binStr = (latInt >>> 0).toString(2).padStart(32, "0") + (lngInt >>> 0).toString(2).padStart(32, "0");

            // 将二进制字符串从左到右每两位分割成一组，将每组转换为一个十进制数字
            const index = [];
            for (let i = 0; i < binStr.length; i += 2) {
                const group = binStr.slice(i, i + 2);
                index.push(parseInt(group, 2));
            }

            // if (frame === 0) {
            //     this.idxxx.push(index);
            //
            //     let hasDel = true;
            //     while (hasDel) {
            //         hasDel = false;
            //         for (let i = 0; i < this.idxxx.length - 1; i++) {
            //             if (this.idxxx[i].join("") === this.idxxx[i + 1].join("")) {
            //                 this.idxxx.splice(i, 1);
            //                 i--;
            //                 hasDel = true;
            //             }
            //         }
            //     }
            //
            //     console.log(this.idxxx.sort((a, b) => (a[1] - b[1])));
            // }
            return index;
        }

        // 比较两个经纬度索引值的大小
        const compareLatLngIndex = (index1, index2) => {
            for (let i = 0; i < 32; i++) {
                // 32 是经纬度索引值的长度
                if (index1[i] === index2[i]) {
                    continue;
                } else {
                    return index1[i] > index2[i] ? 1 : -1;
                }
            }
            return 0;
        }

        this.orderedData[frame] = this.baseData[frame].sort((a, b) => {
            return compareLatLngIndex(latLngToIndex(a.LatitudeGPS, a.LongitudeGPS, a.TrackID), latLngToIndex(b.LatitudeGPS, b.LongitudeGPS, b.TrackID));
        });

        this.orderedToID[frame] = this.orderedData[frame].map((d) => {
            return d.TrackID;
        });
    }

    getDeciles(feature = "Velocity") {
        const flattedData = this.baseData.flat();
        flattedData.sort((a, b) => {
            return a[feature] - b[feature];
        });
        for (let i = 1; i < 10; i++) {
            this.deciles[i - 1] = flattedData[Math.floor(i / 10 * flattedData.length)][feature];
        }
    }

}

motionRugsDataset = new MotionRugsDataset();

// ========================= events =========================
class EventProcessor {
    constructor() {
        this.eventColor = [
            "#a0cfff",
            "#f3d19e",
            "#f89898",
        ]
        this.eventTag = [
            "primary",
            "warning",
            "danger",
        ]
        this.msgTag = [
            "info",
            "warning",
            "error",
        ]
        this.btnTag = [
            "primary",
            "warning",
            "danger",
        ]
        this.eventMarkers = {};
        this.gIdx = 0;
    }

    newEvent(rank, img, msg, pos, loc) {
        const tempEvent = {
            idx: this.gIdx,
            rk: Math.floor(rank),
            clr: this.eventColor[Math.floor(rank)],
            img: img,
            msg: msg,
            pos: pos,
            loc: loc,
            tag: this.eventTag[Math.floor(rank)],
        }
        events.push(tempEvent)
        events.sort((a, b) => {
            return b.rk - a.rk;
        });

        this.eventMarkers[this.gIdx] = L.marker(loc, {
            icon: L.icon({
                iconUrl: (rank >= 2 ? '/dangerous.svg' : (rank >= 1 ? '/warning.svg' : '/info.svg')),
                iconSize: [28, 28],
            })
        }).addTo(map).bindPopup(msg).openPopup();
        this.gIdx++;
        mapController.sidebar.open("allEvents");
        map.panTo(loc);

        if (tempEvent.rk > 1) {
            ElMessage({
                message: msg,
                type: this.msgTag[Math.floor(rank)],
                duration: 0,
                showClose: true,
            });
        }
    }

    finishEvent(idx) {
        this.eventMarkers[idx].remove();
        delete this.eventMarkers[idx];
        for (let i = 0; i < events.length; i++) {
            if (events[i].idx === idx) {
                events.splice(i, 1);
                break;
            }
        }
    }

    findEvent(idx) {
        for (let i = 0; i < events.length; i++) {
            if (events[i].idx === idx) {
                map.panTo(events[i].loc);
                break;
            }
        }
        this.eventMarkers[idx].openPopup();
    }

    moversGo(idx) {
        let loc;
        for (let i = 0; i < events.length; i++) {
            if (events[i].idx === idx) {
                loc = events[i].loc;
                break;
            }
        }

        for (let i = 0; i < Object.keys(movers).length; i++) {
            const mover = movers[Object.keys(movers)[i]];
            mover.newData(loc, 0, 50, 1);
        }
    }
}

eventProcessor = new EventProcessor();
// ========================= 数据监听 =========================


onMounted(() => {
    myMap.createMap();
    mapController = new MapController();

    motionRugs.canvas = document.getElementById("canvas");
    motionRugs.ctx = motionRugs.canvas.getContext("2d");
    motionRugs.canvas.width = pixelContainerRef.value.clientWidth;
    motionRugs.canvas.height = 14 * motionRugs.resizeScale;

    motionRugsDataset.setMaxDataLength(pixelContainerRef.value.clientWidth)
    DataAdaptor.Listener((data) => {
        const {type} = data;
        if (type === "Trajectory") {
            const {fData, fNum} = data;

            if (fData[0].Time !== -11) {
                motionRugsDataset.newData(fData);
            }

            fData.forEach((item) => {
                const {Time, TrackID, LatitudeGPS, LongitudeGPS, Velocity, Acceleration, Type} = item;
                const loc = [LatitudeGPS, LongitudeGPS];
                if (!(TrackID in movers)) {
                    movers[TrackID] = new Mover(TrackID, Type);
                    movers[TrackID].setFrameLength(pixelContainerRef.value.clientWidth);
                }
                if (Time !== -11) {
                    movers[TrackID].newData(loc, fNum, Velocity, Acceleration)
                }
            });
        } else if (type === "Event") {
            const {rank, img, msg, pos, loc} = data;
            eventProcessor.newEvent(rank, img, msg, pos, loc);
        }
    });
});

const findMover = (id) => {
    console.log("findMover", id);

    myMap.nowCenter = movers[id].locList[movers[id].locList.length - 1];
    map.panTo(movers[id].locList[movers[id].locList.length - 1]);

};
const clkMotionRugs = (e) => {
    const x = e.offsetX - 1;
    const y = e.offsetY - 1;
    const frameNum = Math.floor(x / motionRugs.resizeScale);
    const trackID = Math.floor(y / motionRugs.resizeScale);

    if (frameNum < 0 || frameNum >= motionRugsDataset.baseData.length) {
        motionRugs.clearAllMask();
    } else {
        motionRugs.setHasRecMask(false);
        motionRugs.setHasLineMask(true, frameNum, trackID);
        console.log(`clkMotionRugs: frameNum: ${frameNum}, trackID: ${trackID}, x: ${x}, y: ${y}`);
    }
}

const rclkMotionRugs = (e) => {
    e.preventDefault();
    const x = e.offsetX - 1;
    const y = e.offsetY - 1;
    const frameNum = Math.floor(x / motionRugs.resizeScale);
    const trackID = Math.floor(y / motionRugs.resizeScale);

    if (frameNum < 0 || frameNum >= motionRugsDataset.baseData.length) {
        motionRugs.clearAllMask();
    } else {
        motionRugs.setHasLineMask(false);
        motionRugs.setHasRecMask(true, frameNum, trackID);
        console.log(`rclkMotionRugs: frameNum: ${frameNum}, trackID: ${trackID}, x: ${x}, y: ${y}`);

    }
}
</script>

<template>
    <div id="map">
        <div id="sidebar" class="leaflet-sidebar collapsed">
            <div class="leaflet-sidebar-tabs">
                <ul role="tablist">
                    <li>
                        <a href="#allMovers" role="tab" class="tab-icon">
                            <img src="/watching.svg" width="30" height="40" alt=""/>
                        </a>
                    </li>
                    <li>
                        <a href="#allEvents" role="tab" class="tab-icon">
                            <img src="/alert.svg" width="30" height="40" alt=""/>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="leaflet-sidebar-content">
                <div class="leaflet-sidebar-pane" id="allMovers">
                    <h1 class="leaflet-sidebar-header">设备监视</h1>
                    <div v-for="(value, key) of movers">
                        <el-card class="mover-card">
                            <template #header>
                                <div class="mover-card-header">
                                    <span class="mover-card-title"
                                          :style="{ color:`${movers[key].hasPolyLines  ? 'green' : (movers[key].staticPolyLines.length !== 0 ? 'blue' : 'black')}` }"> 设备编号：{{
                                        parseInt(key)
                                        }} </span>
                                    <el-button type="primary" @click="findMover(key)" circle>
                                        <img src="/position-white.svg" width="14" height="14" alt=""/>
                                    </el-button>
                                </div>
                            </template>
                            <el-descriptions direction="vertical" :column="3" :border="true">
                                <el-descriptions-item label="当前帧号">
                                    {{ value.locList.length - 1 + value.startRealFrame }}
                                </el-descriptions-item>
                                <el-descriptions-item label="当前速度">
                                    {{ parseFloat(value.velocityList[value.locList.length - 1]).toFixed(2) }} km/h
                                </el-descriptions-item>
                                <el-descriptions-item label="当前加速度">
                                    {{ parseFloat(value.accelerationList[value.locList.length - 1]).toFixed(2) }} m/s²
                                </el-descriptions-item>
                                <el-descriptions-item label="当前坐标">
                                    {{ parseFloat(value.locList[value.locList.length - 1][0]).toFixed(6) }},
                                    {{ parseFloat(value.locList[value.locList.length - 1][1]).toFixed(6) }}
                                </el-descriptions-item>
                            </el-descriptions>
                        </el-card>
                    </div>
                </div>

                <div class="leaflet-sidebar-pane" id="allEvents">
                    <h1 class="leaflet-sidebar-header">事件监视</h1>
                    <div v-for="item in events">
                        <el-card class="event-card">
                            <img :src="item.img" :style="{objectFit: 'fill', height: '200px', width: '100%'}" alt=""/>
                            <el-descriptions direction="horizontal" :column="1" :border="true">
                                <el-descriptions-item label="类型">
                                    <el-tag :type="item.tag" effect="dark">{{ item.msg }}</el-tag>
                                </el-descriptions-item>
                                <el-descriptions-item label="位置">{{ item.pos }}</el-descriptions-item>
                            </el-descriptions>
                            <div>
                                <el-button :style="{width: '100%'}" @click="eventProcessor.findEvent(item.idx)">
                                    定位
                                </el-button>
                            </div>
                            <div>
                                <el-popconfirm title="是否派遣设备？" confirm-button-text="确定"
                                               cancel-button-text="取消"
                                               @confirm="eventProcessor.moversGo(item.idx)">
                                    <template #reference>
                                        <el-button :style="{width: '100%'}">
                                            快速派遣
                                        </el-button>
                                    </template>
                                </el-popconfirm>
                            </div>
                            <div>
                                <el-popconfirm title="完成这个事件？" confirm-button-text="确定"
                                               cancel-button-text="取消"
                                               @confirm="eventProcessor.finishEvent(item.idx)">
                                    <template #reference>
                                        <el-button :type="item.tag" :style="{width: '100%'}">
                                            完成事件
                                        </el-button>
                                    </template>
                                </el-popconfirm>
                            </div>
                        </el-card>
                    </div>
                </div>

                <div class="leaflet-sidebar-pane" id="allControl">
                    <h1 class="leaflet-sidebar-header">路径设置</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="motionrugs-container" ref="pixelContainerRef" v-loading="motionRugsDataset.baseData.length === 0">
        <canvas id="canvas" @click="clkMotionRugs" @click.right="rclkMotionRugs"
                @click.middle="motionRugs.clearAllMask"></canvas>
    </div>
</template>

<style>
#map {
    width: 100%;
    height: calc(100vh - 84px);
}

.mover-card {
    margin-bottom: 10px;
    margin-top: 10px;
}

.mover-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mover-card-title {
    font-size: 20px;
    font-weight: bold;
}

.el-card > .el-card__body {
    padding: 0;
}

.motionrugs-container {
    width: 100%;
    background-color: #fafaf8;
}

.event-card {
    margin-bottom: 10px;
    margin-top: 10px;
}
</style>
